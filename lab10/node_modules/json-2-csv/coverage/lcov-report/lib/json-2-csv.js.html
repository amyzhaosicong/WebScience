<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for lib/json-2-csv.js</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../prettify.css">
    <link rel="stylesheet" href="../base.css">
    <style type='text/css'>
        div.coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class="header high">
    <h1>Code coverage report for <span class="entity">lib/json-2-csv.js</span></h1>
    <h2>
        Statements: <span class="metric">94.12% <small>(64 / 68)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Branches: <span class="metric">86.96% <small>(40 / 46)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Functions: <span class="metric">100% <small>(15 / 15)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Lines: <span class="metric">95.31% <small>(61 / 64)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../index.html">All files</a> &#187; <a href="index.html">lib/</a> &#187; json-2-csv.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132</td><td class="line-coverage"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">100</span>
<span class="cline-any cline-yes">100</span>
<span class="cline-any cline-yes">100</span>
<span class="cline-any cline-yes">276</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">276</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">100</span>
<span class="cline-any cline-yes">22</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">78</span>
<span class="cline-any cline-yes">78</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">254</span>
<span class="cline-any cline-yes">254</span>
<span class="cline-any cline-yes">30</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">78</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">390</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">390</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">934</span>
<span class="cline-any cline-yes">934</span>
<span class="cline-any cline-yes">114</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">820</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">390</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">410</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">410</span>
<span class="cline-any cline-yes">840</span>
<span class="cline-any cline-yes">840</span>
<span class="cline-any cline-yes">174</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">174</span>
<span class="cline-any cline-yes">666</span>
<span class="cline-any cline-yes">666</span>
<span class="cline-any cline-yes">666</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">410</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">666</span>
<span class="cline-any cline-yes">30</span>
<span class="cline-any cline-yes">636</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-yes">636</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">636</span>
<span class="cline-any cline-yes">636</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">90</span>
<span class="cline-any cline-yes">236</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">143</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">122</span>
<span class="cline-any cline-yes">122</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">122</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">102</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">100</span>
<span class="cline-any cline-yes">22</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">100</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">90</span>
<span class="cline-any cline-yes">20</span>
<span class="cline-any cline-yes">56</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">90</span>
<span class="cline-any cline-yes">90</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">'use strict';
&nbsp;
var _ = require('underscore'),
    constants = require('./constants'),
    Promise = require('bluebird');
&nbsp;
var options = {}; // Initialize the options - this will be populated when the json2csv function is called.
&nbsp;
// Retrieve the headings for all documents and return it.  This checks that all documents have the same schema.
var generateHeading = function(data) {
    return new Promise(function (resolve, reject) {
        if (options.KEYS) { resolve(options.KEYS); }
        var keys = _.map(_.keys(data), function (key, indx) { // for each key
            <span class="missing-if-branch" title="else path not taken" >E</span>if (_.isObject(data[key])) {
                // if the data at the key is a document, then we retrieve the subHeading starting with an empty string heading and the doc
                return generateSubHeading('', data[key]);
            }
<span class="cstat-no" title="statement not covered" >            return key;</span>
        });
&nbsp;
        // Check for a consistent schema that does not require the same order:
        // if we only have one document - then there is no possiblility of multiple schemas
        if (keys &amp;&amp; keys.length &lt;= 1) {
            return resolve(_.flatten(keys) || <span class="branch-1 cbranch-no" title="branch not covered" >[])</span>;
        }
        // else - multiple documents - ensure only one schema (regardless of field ordering)
        var firstDocSchema = _.flatten(keys[0]);
        _.each(keys, function (keyList) {
            // If there is a difference between the schemas, throw the inconsistent schema error
            var diff = _.difference(firstDocSchema, _.flatten(keyList));
            if (!_.isEqual(diff, [])) {
                return reject(new Error(constants.Errors.json2csv.notSameSchema));
            }
        });
        return resolve(_.flatten(keys[0]));
    });
};
&nbsp;
// Takes the parent heading and this doc's data and creates the subdocument headings (string)
var generateSubHeading = function(heading, data) {
    var subKeys, // retrieve the keys from the current document
        newKey = ''; // temporary variable to aid in determining the heading - used to generate the 'nested' headings
&nbsp;
    subKeys = _.map(_.keys(data), function (subKey) {
        // If the given heading is empty, then we set the heading to be the subKey, otherwise set it as a nested heading w/ a dot
        newKey = heading === '' ? subKey : heading + '.' + subKey;
        if (_.isObject(data[subKey]) &amp;&amp; !_.isNull(data[subKey]) &amp;&amp; _.isUndefined(data[subKey].length) &amp;&amp; _.keys(data[subKey]).length &gt; 0) { // If we have another nested document
            return generateSubHeading(newKey, data[subKey]); // Recur on the sub-document to retrieve the full key name
        } else {
            return newKey; // Set the key name since we don't have a sub document
        }
    });
&nbsp;
    return subKeys; // Return the headings joined by our field delimiter
};
&nbsp;
// Convert the given data with the given keys
var convertData = function (data, keys) {
    var output = [], // Array of CSV representing converted docs
        value; // Temporary variable to store the current data
&nbsp;
    _.each(keys, function (key) { // For each key
        var indexOfPeriod = _.indexOf(key, '.');
        if (indexOfPeriod &gt; -1) {
            var pathPrefix = key.slice(0, indexOfPeriod),
                pathRemainder = key.slice(indexOfPeriod+1);
            output.push(convertData(data[pathPrefix], [pathRemainder]));
        } else <span class="missing-if-branch" title="else path not taken" >E</span>if (keys.indexOf(key) &gt; -1) { // If the keys contain the current key, then process the data
            value = data[key]; // Set the current data that we are looking at
            convertField(value, output);
        }
    });
    return output; // Return the data joined by our field delimiter
};
&nbsp;
var convertField = function (value, output) {
    if (_.isArray(value)) { // We have an array of values
        output.push(options.DELIMITER.WRAP + '[' + value.join(options.DELIMITER.ARRAY) + ']' + options.DELIMITER.WRAP);
    } else <span class="missing-if-branch" title="if path not taken" >I</span>if (_.isDate(value)) { // If we have a date
<span class="cstat-no" title="statement not covered" >        output.push(value.toString());</span>
    } else <span class="missing-if-branch" title="if path not taken" >I</span>if (_.isObject(value)) { // If we have an object
<span class="cstat-no" title="statement not covered" >        output.push(convertData(value, _.keys(value))); </span>// Push the recursively generated CSV
    } else {
        value = value === null ? '' : value.toString();
        output.push(options.DELIMITER.WRAP + value + options.DELIMITER.WRAP); // Otherwise push the current value
    }
};
&nbsp;
// Generate the CSV representing the given data.
var generateCsv = function (data, headingKeys) {
    // Reduce each JSON document in data to a CSV string and append it to the CSV accumulator
    return Promise.resolve([headingKeys, _.reduce(data, function (csv, doc) {
        return csv += _.flatten(convertData(doc, headingKeys)).join(options.DELIMITER.FIELD) + options.EOL;
    }, '')]);
};
&nbsp;
module.exports = {
&nbsp;
    // Function to export internally
    // Takes options as a document, data as a JSON document array, and a callback that will be used to report the results
    json2csv: function (opts, data, callback) {
        if (!callback) { throw new Error(constants.Errors.callbackRequired); } // If a callback wasn't provided, throw an error
&nbsp;
        <span class="missing-if-branch" title="if path not taken" >I</span>if (!opts) { <span class="cstat-no" title="statement not covered" >return callback(new Error(constants.Errors.optionsRequired)); </span>} // Shouldn't happen, but just in case
        else { options = opts; } // Options were passed, set the global options value
&nbsp;
        if (!data) { return callback(new Error(constants.Errors.json2csv.cannotCallJson2CsvOn + data + '.')); } // If we don't receive data, report an error
&nbsp;
        if (!_.isObject(data)) { // If the data was not a single document or an array of documents
            return callback(new Error(constants.Errors.json2csv.dataNotArrayOfDocuments));  // Report the error back to the caller
        } else if (_.isObject(data) &amp;&amp; !data.length) { // Single document, not an array
            data = [data]; // Convert to an array of the given document
        }
&nbsp;
        // Retrieve the heading and then generate the CSV with the keys that are identified
        generateHeading(data)
            .then(_.partial(generateCsv, data))
            .spread(function (csvHeading, csvData) {
                if (options.DELIMITER.WRAP) {
                    csvHeading = _.map(csvHeading, function(headingKey) {
                        return options.DELIMITER.WRAP + headingKey + options.DELIMITER.WRAP;
                    });
                }
                csvHeading = csvHeading.join(options.DELIMITER.FIELD);
                return callback(null, [csvHeading, csvData].join(options.EOL));
            })
            .catch(function (err) {
                return callback(err);
            });
    }
&nbsp;
};</pre></td></tr>
</table></pre>

</div>
<div class="footer">
    <div class="meta">Generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Apr 17 2015 15:38:48 GMT-0400 (EDT)</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
